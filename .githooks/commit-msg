#!/usr/bin/env python
# Based on a hook from dzone.com
# Source: https://dzone.com/articles/an-in-depth-look-at-git-hooks
#
# Makes sure user did not delete the ANDLDBR-[#] string that was generated by prepare-commit-msg
#
# The hook should exit with non-zero status after issuing an appropriate
# message if it stops the commit.
#
# Requirements: 
#   * Python 2/3

import sys, os, re
from subprocess import check_output

# Collect the parameters
commit_msg_filepath = sys.argv[1]

# Figure out which branch we're on
branch = check_output(['git', 'symbolic-ref', '--short', 'HEAD']).strip()
print ("commit-msg: On branch '%s'" % branch)

# Check the commit message if we're on an ANDLDBR branch
if branch.startswith(b'ANDLDBR-'):
    print ("commit-msg: Checking ANDLDBR key...")
    result = re.match('ANDLDBR-(.*)', branch.decode())
    task_number = result.group(1)
    required_message = "ANDLDBR-%s" % task_number.split("-")[0]
    with open(commit_msg_filepath, 'r') as f:
        content = f.read()
    if not content.startswith(required_message):
        print ("commit-msg: ERROR! The commit message must start with '%s'" % required_message)
        sys.exit(1)
